<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Supabase Auth Debug</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .card { background: white; padding: 2rem; border: 1px solid #ccc; border-radius: 8px; max-width: 600px; margin: 0 auto; }
        #log { background: #f4f4f4; border: 1px solid #ddd; padding: 10px; font-family: monospace; font-size: 12px; margin-top: 20px; min-height: 100px; white-space: pre-wrap; word-break: break-all; }
        .error { color: red; background: #ffe6e6; }
        .success { color: green; }
    </style>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="card">
        <h3 id="status">正在启动调试模式...</h3>
        <p>如果长时间卡在这里，请看下方的日志。</p>
        <button onclick="window.location.reload()" style="padding:10px;">刷新页面</button>
        <div id="log">等待日志...</div>
    </div>

    <script>
        // === 1. 定义屏幕日志工具 (防止看不到控制台) ===
        const logBox = document.getElementById('log');
        const statusText = document.getElementById('status');
        
        function printLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const line = `[${time}] ${msg}\n`;
            logBox.innerText += line;
            console.log(msg);
            if(type === 'error') {
                statusText.innerText = "❌ 发生错误";
                statusText.style.color = "red";
                logBox.classList.add('error');
            }
        }

        // === 2. 全局错误捕获 (捕捉 CDN 加载失败等底层错误) ===
        window.onerror = function(message, source, lineno, colno, error) {
            printLog(`全局错误: ${message}\n位置: ${source}:${lineno}`, 'error');
            return true;
        };

        // === 3. 开始执行业务逻辑 ===
        (async function() {
            printLog("1. 脚本开始执行");

            // 检查 Supabase 库是否加载
            if (!window.supabase) {
                printLog("致命错误: window.supabase 未定义！\nCDN文件未加载成功，可能是网络问题。", 'error');
                return;
            }
            printLog("2. Supabase 库加载检测通过");

            // ================= 配置区域 =================
            const SUPABASE_URL = 'https://scdsetruethlhxmqmjoy.supabase.co';
            // 你的 Anon Key (请确认这里是正确的)
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjZHNldHJ1ZXRobGh4bXFtam95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTE3NTksImV4cCI6MjA4MjU4Nzc1OX0.MlODufWwIUPzbi-AskwaKGRC4Lxwv6RlBd_utFYUrGw'; 
            
            // 注意：因为我不知道你完整的真实 Key，上面我只保留了前缀。
            // ★★★ 请务必把这里换回你在 Dashboard 复制的那个完整的 Key ★★★
            // ===========================================

            try {
                // 初始化
                const { createClient } = window.supabase;
                // 这里加个 try-catch 专门捕获 createClient 格式错误
                let supabase;
                try {
                    supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
                    printLog("3. createClient 初始化成功");
                } catch (initErr) {
                    throw new Error("初始化失败，Key格式可能不对: " + initErr.message);
                }

                // 获取 Session
                printLog("4. 正在连接 Supabase 获取 Session...");
                const { data, error } = await supabase.auth.getSession();

                if (error) {
                    throw error;
                }

                if (data.session) {
                    printLog("5. ✅ 状态：已登录 (Token有效)");
                    printLog("Email: " + data.session.user.email);
                    
                    if (window.opener) {
                        printLog("6. 检测到父窗口，发送消息...");
                        window.opener.postMessage({
                            type: 'SUPABASE_AUTH_SUCCESS',
                            session: data.session
                        }, '*');
                        printLog(">> 消息已发送，1秒后关闭");
                        setTimeout(() => window.close(), 1000);
                    } else {
                        printLog("⚠️ 没有父窗口 (可能是直接访问的页面)，无法回调。");
                    }
                } else {
                    printLog("5. 状态：未登录");
                    printLog(">> 准备跳转 Google...");
                    
                    const { error: signInError } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: window.location.href,
                            queryParams: { prompt: 'select_account' }
                        }
                    });
                    
                    if (signInError) throw signInError;
                    printLog(">> 跳转请求已发出");
                }

            } catch (err) {
                printLog("逻辑错误: " + err.message, 'error');
                printLog(JSON.stringify(err, null, 2));
            }
        })();
    </script>
</body>
</html>