<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Supabase Auth Redirect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #f4f4f4; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
        }
        .card { 
            background: white; 
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            text-align: center; 
            max-width: 400px; 
            width: 90%; 
        }
        h3 { margin-top: 0; color: #333; }
        p { color: #666; font-size: 14px; margin-bottom: 0; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="card">
        <div class="loader"></div>
        <h3 id="status-title">正在验证身份...</h3>
        <p id="status-msg">请稍候，正在连接安全服务</p>
    </div>

    <script>
        (async function() {
            // ================= 配置区域 =================
            const SUPABASE_URL = 'https://scdsetruethlhxmqmjoy.supabase.co';
            // 你的 Anon Key (请确认这里是正确的)
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjZHNldHJ1ZXRobGh4bXFtam95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTE3NTksImV4cCI6MjA4MjU4Nzc1OX0.MlODufWwIUPzbi-AskwaKGRC4Lxwv6RlBd_utFYUrGw'; 
            
            // 注意：因为我不知道你完整的真实 Key，上面我只保留了前缀。
            // ★★★ 请务必把这里换回你在 Dashboard 复制的那个完整的 Key ★★★
            // ===========================================

            const updateStatus = (title, msg) => {
                document.getElementById('status-title').innerText = title;
                if(msg) document.getElementById('status-msg').innerText = msg;
            };

            try {
                if (!window.supabase) throw new Error("Supabase SDK加载失败");
                const { createClient } = window.supabase;
                const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

                // 获取 Session
                const { data, error } = await supabase.auth.getSession();
                if (error) throw error;

                if (data.session) {
                    // === 已登录 ===
                    updateStatus("验证成功", "正在返回应用...");
                    
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'SUPABASE_AUTH_SUCCESS',
                            session: data.session
                        }, '*');
                        // 稍微延迟一下关闭，让用户有个视觉反馈，也确保消息发出
                        setTimeout(() => window.close(), 500);
                    } else {
                        updateStatus("已登录", "未检测到父窗口，请手动关闭此页面");
                    }
                } else {
                    // === 未登录，跳转 Google ===
                    updateStatus("正在跳转...", "即将前往 Google 登录");
                    
                    const { error: signInError } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: window.location.href,
                            queryParams: { prompt: 'select_account' }
                        }
                    });
                    
                    if (signInError) throw signInError;
                }

            } catch (err) {
                console.error("Auth Error:", err);
                // 仅在出错时显示红色提示，不显示具体堆栈信息
                const titleEl = document.getElementById('status-title');
                titleEl.innerText = "验证失败";
                titleEl.style.color = "red";
                document.getElementById('status-msg').innerText = "无法完成认证，请刷新重试。";
                // 停止转圈动画
                document.querySelector('.loader').style.borderTop = "4px solid red";
                document.querySelector('.loader').style.animation = "none";
            }
        })();
    </script>
</body>
</html>